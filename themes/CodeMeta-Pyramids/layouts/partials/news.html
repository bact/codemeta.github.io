<div id="newslinks" class="container pt-2">
  <h3 class="ms-3">News</h3>
  <ul class="list-group list-unstyled">
    {{ if .IsHome }}

{{ $items := slice }}

{{ range $feed := .Site.Data.feeds }}
{{ $item := index $feed.channel "item" }}
{{ $items = $items | append $item }}
{{ end }}

{{ $combi := slice }}

{{- range $items -}}
{{ $t := time.AsTime .pubDate }}
{{ $m := dict "link" .link "title" .title "pubDate" $t "description" .description }}
{{ $combi = $combi | append $m }}
{{- end -}}

{{ $combi := sort $combi ".pubDate" "desc" }}

  {{ range first .Site.Params.newslimit $combi }}

    <li class="ps-2">
      <a class="list-group-item newslink lh-base p-2" href="{{ .link }}">{{ .title }}</a>
      <small class="p-2 text-secondary-emphasis">{{ .pubDate | time.Format "Jan 02, 2006 3:04 PM MST" }}</small>
    </li>
      {{ end }}
    {{ else }}
      {{ range $combi }}
    <li class="ps-2">
      <a class="list-group-item newslink lh-base p-2" href="{{ .link }}">{{ .title }}</a>
      <small class="p-2 text-secondary-emphasis">{{ .pubDate | time.Format "Jan 02, 2006 3:04 PM MST" }}</small>
    </li>
      {{ end }}
    {{ end }}
  </ul>
    {{ if .IsHome }}<div class="text-center"><small class="mw-100 text-secondary-emphasis"><a href="/news">Full news feed</a></small></div>{{ end }}
</div>
<script>

function formatAMPM(date) {
    var hours = date.getUTCHours();
    var minutes = date.getUTCMinutes();
    var ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    minutes = minutes < 10 ? '0'+minutes : minutes;
    var strTime = hours + ':' + minutes + ' ' + ampm;
    return strTime;
}

async function fetchCodeMetaPostsFromSWHWordPress() {
    let url = `https://softwareheritage.org/tag/codemeta/feed/`;
    let response = await fetch(url, {
        method: "GET",
    });

    const text = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, "text/xml");
    const items = doc.getElementsByTagName("item");

    $("#newslinks ul").empty();
    for (let i = 0 ; i < items.length ; ++i) {
        const title = items[i].querySelector("title").textContent;
        const link = items[i].querySelector("link").textContent;
        const date = new Date(items[i].querySelector("pubDate").textContent);
        const desc = items[i].querySelector("description").textContent;

        const year = date.getUTCFullYear();
        const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        const month = months[date.getUTCMonth()];
        const day = date.getUTCDate().toString().padStart(2, '0');
        const timestr = formatAMPM(date);

        const utc = `${month} ${day}, ${year} ${timestr} UTC`

        if (i <= ({{ .Site.Params.newslimit }} - 1 ))
            $("#newslinks ul").append(
                `<li class="ps-2 refreshed">
                  <a class="list-group-item newslink lh-base p-2" href="${link}">${title}</a>
                  <small class="p-2 text-secondary-emphasis">${utc}</small>
                </li>`
            )
    };
}

fetchCodeMetaPostsFromSWHWordPress();
</script>
